---
title: "리뷰"
excerpt: "리뷰 내재화"
date: "2023-07-31"
ogImage: /assets/cover.png
---

sdk

LOAD
OPEN_MODAL
CLOSE_MODAL
RESIZE
LINK

- 링크를 통해 상품 상세 페이지로 이동.

INVALIDATE_QURIES - 다른 iframe의 query를 invalidate 하기 위해 사용.

1. iframe이 그려지면 useEffect에서 LOAD타입의 이벤트를 전달.
2. sdk에서 LOAD를 받으면 iframe id, 사이트코드, 상품코드 등 화면을 그리는데 필요한 데이터를 iframe으로 전달.
3. iframe에서 데이터를 받아서 컨텍스트로 사용.
4. iframe에서 OPEN_MODAL과 src를 postMessage로 전달함. sdk에서는 OPEN_MODAL을 받아서 새로운 iframe 생성.
5. iframe에서 CLOSE_MODAL과 id를 전달하면 sdk에서 id에 해당하는 iframe.remove();

```javascript
postMessage({ type: "CLOSE_MODAL", id: contextInfo?.id || "" });
```

6. iframe에서 RESIZE와 id, height를 전달하면 sdk에서 높이 수정.

sdk에서 message를 핸들링할때 origin 체크

```javascript
postMessage({ type: "OPEN_MODAL", src });
```

1. 태그에 사이트 코드, 상품 코드, 유저 id를 data-attribute로 추가하고, class명으로 어떤 리뷰 화면을 보여줄지 결정

2. 처음엔 바로 스크립트 실행 => 내부 메소드를 호출하는 식으로 변경.
   리뷰를 그리는 영역이 동적으로 추가되는 경우도 있기 때문.

3. iframe 높이 설정- ResizeObserver 사용

   ```javascript
   useEffect(() => {
     if (!contextInfo) return;

     let height = 0;
     const callback: ResizeObserverCallback = (entries) => {
       entries.forEach((entry) => {
         if (height !== entry.contentRect.height) {
           height = entry.contentRect.height;
         }
       });
       postMessage({
         id: contextInfo.id,
         type: "RESIZE",
         height: height + "px",
       });
     };

     const resizeObserver = new ResizeObserver(callback);
     resizeObserver.observe(document.body);

     return () => {
       resizeObserver.disconnect();
     };
   }, [contextInfo]);
   ```

   sdk에서 높이값 받아서 설정

   ```javascript
   iframe.style.height = e.data.height;
   ```

4. iframe에서 리뷰 작성이나 수정시 다른 iframe에있는 리뷰 목록에 대한 queryInvalidation이 필요함.
   mutation 성공시 invalidate를 수행할 쿼리 키와 업데이트할 classname, type: INVALIDATE_QUERY를 전달.

```javascript
postMessage({
  type: "INVALIDATE_QUERIES",
  queryKeys: [
    ["writtenReviews"],
    ["writableReviews"],
    reviewKeys.count.totalCount,
    reviewKeys.count.likedCount,
    reviewKeys.count.bestCount,
  ],
  className: "review-mypage-product",
});
```

sdk에서는 classname으로 업데이트를 할 iframe을 찾아 전달받은queryKey와 함께 postMessage 호출.
iframe에서 queryKey를 받아서 invalidateQuries 수행.

```javascript
e.data.queryKeys.map((queryKey: QueryKey) => {
  queryClient.invalidateQueries({ queryKey });
});
```
